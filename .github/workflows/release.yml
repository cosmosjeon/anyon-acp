name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  # Build jobs for each platform
  build-linux:
    uses: ./.github/workflows/build-linux.yml
    secrets: inherit

  build-macos:
    uses: ./.github/workflows/build-macos.yml
    secrets: inherit

  build-windows:
    uses: ./.github/workflows/build-windows.yml
    secrets: inherit

  # Create release after all builds complete
  create-release:
    name: Create Release
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="${{ inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          VERSION="${{ steps.version.outputs.version }}"
          CLEAN_VERSION="${VERSION#v}"

          # Linux artifacts
          if [ -d "artifacts/linux-x86_64" ]; then
            cp artifacts/linux-x86_64/*.deb release-assets/ANYON_${VERSION}_linux_x86_64.deb || true
            cp artifacts/linux-x86_64/*.AppImage release-assets/ANYON_${VERSION}_linux_x86_64.AppImage || true
            cp artifacts/linux-x86_64/*.AppImage.sig release-assets/ANYON_${VERSION}_linux_x86_64.AppImage.sig || true
          fi

          # macOS artifacts
          if [ -d "artifacts/macos-universal" ]; then
            cp artifacts/macos-universal/ANYON.dmg release-assets/ANYON_${VERSION}_macos_universal.dmg || true
            cp artifacts/macos-universal/ANYON.app.zip release-assets/ANYON_${VERSION}_macos_universal.app.tar.gz || true
          fi

          # macOS updater artifacts (from arch-specific builds)
          if [ -d "artifacts/macos-aarch64" ]; then
            cp artifacts/macos-aarch64/*.tar.gz release-assets/ANYON_${VERSION}_macos_aarch64.app.tar.gz || true
            cp artifacts/macos-aarch64/*.tar.gz.sig release-assets/ANYON_${VERSION}_macos_aarch64.app.tar.gz.sig || true
          fi
          if [ -d "artifacts/macos-x86_64" ]; then
            cp artifacts/macos-x86_64/*.tar.gz release-assets/ANYON_${VERSION}_macos_x86_64.app.tar.gz || true
            cp artifacts/macos-x86_64/*.tar.gz.sig release-assets/ANYON_${VERSION}_macos_x86_64.app.tar.gz.sig || true
          fi

          # Windows artifacts
          if [ -d "artifacts/windows-x86_64" ]; then
            cp artifacts/windows-x86_64/*.msi release-assets/ANYON_${VERSION}_windows_x86_64.msi || true
            cp artifacts/windows-x86_64/*.msi.sig release-assets/ANYON_${VERSION}_windows_x86_64.msi.sig || true
            cp artifacts/windows-x86_64/*.exe release-assets/ANYON_${VERSION}_windows_x86_64.exe || true
            cp artifacts/windows-x86_64/*-setup.exe.sig release-assets/ANYON_${VERSION}_windows_x86_64-setup.exe.sig || true
          fi

          # Create source code archives (excluding .git and other unnecessary files)
          echo "Creating source code archives..."
          git archive --format=tar.gz --prefix=ANYON-${CLEAN_VERSION}/ -o release-assets/ANYON-${CLEAN_VERSION}.tar.gz HEAD
          git archive --format=zip --prefix=ANYON-${CLEAN_VERSION}/ -o release-assets/ANYON-${CLEAN_VERSION}.zip HEAD

          # Generate SHA256 checksums for all files
          cd release-assets
          for file in *; do
            if [ -f "$file" ] && [[ "$file" != *.sha256 ]]; then
              sha256sum "$file" > "$file.sha256"
            fi
          done
          cd ..

      - name: Generate latest.json for auto-updater
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CLEAN_VERSION="${VERSION#v}"
          REPO="${{ github.repository }}"
          PUB_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Read signatures
          LINUX_SIG=""
          MACOS_AARCH64_SIG=""
          MACOS_X86_64_SIG=""
          WINDOWS_SIG=""

          if [ -f "release-assets/ANYON_${VERSION}_linux_x86_64.AppImage.sig" ]; then
            LINUX_SIG=$(cat "release-assets/ANYON_${VERSION}_linux_x86_64.AppImage.sig")
          fi
          if [ -f "release-assets/ANYON_${VERSION}_macos_aarch64.app.tar.gz.sig" ]; then
            MACOS_AARCH64_SIG=$(cat "release-assets/ANYON_${VERSION}_macos_aarch64.app.tar.gz.sig")
          fi
          if [ -f "release-assets/ANYON_${VERSION}_macos_x86_64.app.tar.gz.sig" ]; then
            MACOS_X86_64_SIG=$(cat "release-assets/ANYON_${VERSION}_macos_x86_64.app.tar.gz.sig")
          fi
          if [ -f "release-assets/ANYON_${VERSION}_windows_x86_64.msi.sig" ]; then
            WINDOWS_SIG=$(cat "release-assets/ANYON_${VERSION}_windows_x86_64.msi.sig")
          fi

          # Create latest.json
          cat > release-assets/latest.json << EOF
          {
            "version": "${CLEAN_VERSION}",
            "notes": "ANYON ${VERSION} - See release notes on GitHub",
            "pub_date": "${PUB_DATE}",
            "platforms": {
              "darwin-aarch64": {
                "signature": "${MACOS_AARCH64_SIG}",
                "url": "https://github.com/${REPO}/releases/download/${VERSION}/ANYON_${VERSION}_macos_aarch64.app.tar.gz"
              },
              "darwin-x86_64": {
                "signature": "${MACOS_X86_64_SIG}",
                "url": "https://github.com/${REPO}/releases/download/${VERSION}/ANYON_${VERSION}_macos_x86_64.app.tar.gz"
              },
              "linux-x86_64": {
                "signature": "${LINUX_SIG}",
                "url": "https://github.com/${REPO}/releases/download/${VERSION}/ANYON_${VERSION}_linux_x86_64.AppImage"
              },
              "windows-x86_64": {
                "signature": "${WINDOWS_SIG}",
                "url": "https://github.com/${REPO}/releases/download/${VERSION}/ANYON_${VERSION}_windows_x86_64.msi"
              }
            }
          }
          EOF

          echo "Generated latest.json:"
          cat release-assets/latest.json
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ANYON ${{ steps.version.outputs.version }}
          draft: true
          prerelease: false
          generate_release_notes: true
          files: release-assets/*
          body: |
            <div align="center">
              <img src="https://raw.githubusercontent.com/${{ github.repository }}/${{ steps.version.outputs.version }}/src-tauri/icons/icon.png" alt="ANYON Logo" width="128" height="128">
            </div>

            ## ANYON ${{ steps.version.outputs.version }}

            This release was built and signed by CI. Artifacts for Windows, macOS, and Linux are attached below.

            - Auto-generated release notes are included below (commits, PRs, and contributors).
            - Checksums (`.sha256`) are provided for all assets.

            ### Downloads

            - **macOS**: `.dmg`, `.app.tar.gz` (Universal: Apple Silicon + Intel)
            - **Linux**: `.AppImage`, `.deb`
            - **Windows**: `.msi`, `.exe` (NSIS installer)

            ### Installation

            - **macOS**: Open the `.dmg` and drag ANYON to Applications.
            - **Linux**: `chmod +x` the `.AppImage` and run it, or install the `.deb` on Debian/Ubuntu.
            - **Windows**: Run the `.msi` installer or `.exe` setup wizard.
            
