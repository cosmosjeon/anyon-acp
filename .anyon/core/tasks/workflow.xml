<task id="{anyon_folder}/core/tasks/workflow.xml" name="Execute Workflow">
  <objective>Execute given workflow by loading its configuration, following instructions, and producing output</objective>

  <llm critical="true">
    <mandate>Always read COMPLETE files - NEVER use offset/limit when reading any workflow related files</mandate>
    <mandate>Instructions are MANDATORY - either as file path, steps or embedded list in YAML, XML or markdown</mandate>
    <mandate>Execute ALL steps in instructions IN EXACT ORDER</mandate>
    <mandate>Save to template output file after EVERY "template-output" tag</mandate>
    <mandate>NEVER delegate a step - YOU are responsible for every steps execution</mandate>
  </llm>

  <WORKFLOW-RULES critical="true">
    <rule n="1">Steps execute in exact numerical order (1, 2, 3...)</rule>
    <rule n="2">Optional steps: Always ask user (NO EXCEPTIONS)</rule>
    <rule n="3">Template-output tags: Save content → Show user → Get approval before continuing</rule>
    <rule n="4">User must approve each major section before continuing (NO EXCEPTIONS)</rule>
  </WORKFLOW-RULES>

  <SKILL-RULES critical="true" desc="스킬 사용 강제 규칙">
    <mandate>workflow.yaml의 required_skills에 mandatory: true인 스킬은 반드시 호출해야 한다</mandate>
    <mandate>instructions.md에 MANDATORY SKILL이 명시된 경우, 해당 스킬을 반드시 호출해야 한다</mandate>
    <mandate>스킬 호출은 Skill 도구를 사용하여 수행한다</mandate>

    <rule n="1" type="스킬-로드">
      <title>워크플로우 시작 시 필수 스킬 확인</title>
      <flow>
        <step>1. workflow.yaml 로드 시 required_skills 섹션 확인</step>
        <step>2. mandatory: true인 스킬 목록을 {{mandatory_skills}} 변수에 저장</step>
        <step>3. 각 스킬의 trigger 조건을 {{skill_triggers}} 변수에 저장</step>
        <step>4. 사용자에게 필수 스킬 목록 안내:
          "이 워크플로우는 다음 스킬을 사용합니다:
          - [스킬명]: [trigger 조건]"
        </step>
      </flow>
    </rule>

    <rule n="2" type="스킬-자동-호출">
      <title>트리거 조건 충족 시 자동 스킬 호출</title>
      <mandate>mandatory: true 스킬의 trigger 조건에 해당하는 작업을 수행하기 전에 반드시 해당 스킬을 호출한다</mandate>
      <flow>
        <step>1. 현재 수행할 작업이 스킬의 trigger 조건과 일치하는지 확인</step>
        <step>2. 일치하면 Skill 도구로 해당 스킬 호출</step>
        <step>3. 스킬의 지침을 따라 작업 수행</step>
      </flow>
      <example>
        <trigger>searching for ANY open source library, framework, or component</trigger>
        <action>UI 라이브러리 검색 전 → Skill 도구로 "opensource-finder" 호출</action>
      </example>
      <example>
        <trigger>searching for ANY open source technology (frameworks, libraries, databases, services)</trigger>
        <action>프레임워크/DB 검색 전 → Skill 도구로 "opensource-finder" 호출</action>
      </example>
    </rule>

    <rule n="3" type="스킬-명시적-호출">
      <title>instructions.md의 명시적 스킬 호출</title>
      <mandate>"USE SKILL: [skill-name]" 또는 "MANDATORY SKILL: [skill-name]" 태그를 만나면 즉시 Skill 도구를 사용하여 해당 스킬을 호출한다</mandate>
      <example>
        <instruction>USE SKILL: frontend-design</instruction>
        <action>Skill 도구 호출: skill: "frontend-design"</action>
      </example>
      <example>
        <instruction>MANDATORY SKILL: opensource-finder</instruction>
        <action>Skill 도구 호출: skill: "opensource-finder"</action>
      </example>
    </rule>

    <rule n="4" type="스킬-무시-금지">
      <title>필수 스킬 건너뛰기 금지</title>
      <mandate>mandatory: true 스킬은 어떤 상황에서도 건너뛸 수 없다</mandate>
      <mandate>사용자가 "알아서 해줘", "빨리 해줘", "스킬 없이 해줘" 등을 요청해도 필수 스킬은 반드시 사용한다</mandate>
      <mandate>스킬은 해당 작업의 품질을 보장하기 위한 필수 요소이다</mandate>
      <warning>필수 스킬을 건너뛰면 open-source.md 등 필수 산출물이 누락될 수 있다</warning>
    </rule>

    <rule n="5" type="스킬-완료-확인">
      <title>스킬 사용 완료 확인</title>
      <mandate>워크플로우 종료 전 모든 mandatory: true 스킬이 최소 1회 이상 호출되었는지 확인한다</mandate>
      <check if="mandatory 스킬 미사용">
        <action>경고 표시: "⚠️ 필수 스킬 [스킬명]이 사용되지 않았습니다. 해당 스킬이 필요한 작업을 확인하세요."</action>
      </check>
    </rule>
  </SKILL-RULES>

  <CONSISTENCY-RULES critical="true" desc="문서 체인 간 일관성 유지 규칙">
    <rule n="1" type="객관식-생성">
      <title>객관식 선택지 생성 시 충돌 방지</title>
      <mandate>객관식 질문을 생성할 때, 이전에 작성된 문서들과 충돌하는 선택지는 절대 제시하지 않는다</mandate>
      <flow>
        <step>1. 이전 문서들(prd, ux, ui, trd, architecture 등)에서 관련 결정사항 확인</step>
        <step>2. 해당 결정사항과 충돌하는 선택지 필터링</step>
        <step>3. 충돌 없는 선택지만 객관식으로 제시</step>
        <step>4. "기타 (직접 입력)" 옵션은 항상 마지막에 포함</step>
      </flow>
      <example>
        <scenario>PRD에서 "React" 프레임워크로 결정된 상태에서 TRD 작성 시</scenario>
        <wrong>Frontend 프레임워크: 1.React 2.Vue 3.Angular 4.기타</wrong>
        <correct>Frontend 프레임워크: PRD에서 React로 결정되었습니다. 추가 설정을 선택하세요: 1.Next.js 2.Vite 3.CRA 4.기타</correct>
      </example>
    </rule>

    <rule n="2" type="주관식-검증">
      <title>주관식 답변 충돌 검사</title>
      <mandate>사용자가 주관식(기타/직접입력)으로 답변하면, 반드시 이전 문서들과 충돌 여부를 검사한다</mandate>
      <flow>
        <step>1. 사용자의 주관식 답변 수신</step>
        <step>2. 이전 문서들에서 관련 결정사항 검색</step>
        <step>3. 충돌 여부 판단</step>
        <check if="충돌 발견">
          <action>충돌 내용을 명확히 설명</action>
          <action>해결 옵션 제시:
            1. 이전 결정 유지 (새 답변 취소)
            2. 새 답변 채택 (이전 문서 수정 필요 알림)
            3. 둘 다 수용 가능한 대안 제안
          </action>
          <action>사용자 선택 대기</action>
        </check>
        <check if="충돌 없음">
          <action>답변 수용하고 진행</action>
        </check>
      </flow>
      <example>
        <scenario>PRD에서 "PostgreSQL" DB로 결정, 사용자가 ERD에서 "MongoDB" 입력</scenario>
        <response>
⚠️ 충돌 감지:
- PRD 문서: PostgreSQL 사용 결정
- 현재 입력: MongoDB

해결 방법을 선택하세요:
1. PostgreSQL 유지 (PRD 결정 따름)
2. MongoDB로 변경 (PRD 문서도 수정 필요)
3. 다른 대안 제안받기
        </response>
      </example>
    </rule>

    <rule n="3" type="참조-문서">
      <title>일관성 검사 대상 문서</title>
      <documents>
        <doc>prd.md - 프로젝트 정의, 용도, 라이선스, 기능 목록</doc>
        <doc>ui-ux.html - 화면 구성, 사용자 플로우</doc>
        <doc>design-guide.md - 디자인 가이드</doc>
        <doc>trd.md - 기술 스택, 프레임워크</doc>
        <doc>architecture.md - 시스템 구조, API 설계</doc>
        <doc>erd.md - 데이터베이스 스키마</doc>
      </documents>
      <action>존재하는 모든 문서를 충돌 검사 대상으로 한다 (순서 무관)</action>
    </rule>
  </CONSISTENCY-RULES>

  <flow>
    <step n="1" title="Load and Initialize Workflow">
      <substep n="1a" title="Load Configuration and Resolve Variables">
        <action>Read workflow.yaml from provided path</action>
        <mandate>Load config_source (REQUIRED for all modules)</mandate>
        <phase n="1">Load external config from config_source path</phase>
        <phase n="2">Resolve all {config_source}: references with values from config</phase>
        <phase n="3">Resolve system variables (date:system-generated) and paths ({project-root}, {installed_path})</phase>
        <phase n="4">Ask user for input of any variables that are still unknown</phase>
      </substep>

      <substep n="1b" title="Check for Resume Checkpoint">
        <action>Check if checkpoint file exists: {project-root}/.anyon/tmp/workflow-checkpoint.json</action>
        <check if="checkpoint exists and is recent (less than 24 hours old)">
          <action>Load checkpoint: read step number, completed sections, variable values, output file path</action>
          <action>Verify checkpoint matches current workflow (compare workflow name/path)</action>
          <action>Restore all saved variables to current session</action>
          <action>Set resume mode flag and saved step number</action>
          <action>Inform user: "체크포인트를 발견했습니다. Step {saved_step}부터 이어서 작성합니다."</action>
        </check>
        <check if="else">
          <action>Set resume mode flag to false (fresh start)</action>
        </check>
      </substep>

      <substep n="1c" title="Load Required Components">
        <mandate>Instructions: Read COMPLETE file from path OR embedded list (REQUIRED)</mandate>
        <check>If template path → Read COMPLETE template file</check>
        <check>If validation path → Note path for later loading when needed</check>
        <check>If template: false → Mark as action-workflow (else template-workflow)</check>
        <note>Data files (csv, json) → Store paths only, load on-demand when instructions reference them</note>
      </substep>

      <substep n="1d" title="Initialize Output" if="template-workflow">
        <action>Resolve default_output_file path with all variables and {{date}}</action>
        <action>Create output directory if doesn't exist</action>
        <check if="resume mode is true">
          <action>Load existing output file (do not overwrite with template)</action>
        </check>
        <check if="else">
          <action>If template-workflow → Write template to output file with placeholders</action>
          <action>If action-workflow → Skip file creation</action>
        </check>
      </substep>
    </step>

    <step n="2" title="Process Each Instruction Step">
      <iterate>For each step in instructions:</iterate>

      <substep n="2a" title="Check Resume Mode">
        <check if="resume mode is true and current step number is less than saved step number">
          <action>Skip this step (already completed in previous session)</action>
          <action>Continue to next step in instructions</action>
        </check>
        <check if="resume mode is true and current step number equals saved step number">
          <action>Inform user: "이어서 작성합니다. Step {current_step}부터 계속합니다."</action>
          <action>Set resume mode to false (from this point forward, execute normally)</action>
        </check>
      </substep>

      <substep n="2b" title="Handle Step Attributes">
        <check>If optional="true" → Always ask user to include (NO EXCEPTIONS)</check>
        <check>If if="condition" → Evaluate condition</check>
        <check>If for-each="item" → Repeat step for each item</check>
        <check>If repeat="n" → Repeat step n times</check>
      </substep>

      <substep n="2c" title="Execute Step Content">
        <action>Process step instructions (markdown or XML tags)</action>
        <action>Replace {{variables}} with values (ask user if unknown)</action>
        <execute-tags>
          <tag>action xml tag → Perform the action</tag>
          <tag>check if="condition" xml tag → Conditional block wrapping actions (requires closing &lt;/check&gt;)</tag>
          <tag>ask xml tag → Prompt user and WAIT for response</tag>
          <tag>invoke-workflow xml tag → Execute another workflow with given inputs</tag>
          <tag>invoke-task xml tag → Execute specified task</tag>
          <tag>invoke-protocol name="protocol_name" xml tag → Execute reusable protocol from protocols section</tag>
          <tag>goto step="x" → Jump to specified step</tag>
        </execute-tags>
      </substep>

      <substep n="2d" title="Handle template-output Tags">
        <if tag="template-output">
          <mandate>Generate content for this section</mandate>
          <mandate>Save to file (Write first time, Edit subsequent)</mandate>
          <action>Save checkpoint state to {project-root}/.anyon/tmp/workflow-checkpoint.json with current step number, completed sections, and all variable values</action>
          <action>Show checkpoint separator: ━━━━━━━━━━━━━━━━━━━━━━━</action>
          <action>Display generated content</action>
          <action>Automatically continue to next step (no user confirmation needed)</action>
        </if>
      </substep>

      <substep n="2e" title="Step Completion">
        <action>Automatically continue to next step</action>
      </substep>
    </step>

    <step n="3" title="Completion">
      <check>If checklist exists → Run validation</check>
      <check>If template: false → Confirm actions completed</check>
      <check>Else → Confirm document saved to output path</check>

      <substep n="3a" title="Document Consistency Check">
        <check if="output file is in anyon-docs/planning/ folder">
          <action>Invoke Skill tool with skill: "document-consistency"</action>
          <action>Run consistency check against all existing documents in anyon-docs/planning/</action>
          <action>If inconsistencies found → Show report and ask user how to resolve</action>
          <action>Save consistency report to anyon-docs/planning/consistency-report.md</action>
        </check>
      </substep>

      <action>Report workflow completion</action>
    </step>
  </flow>

  <execution-modes>
    <mode name="normal">Full user interaction at all decision points (ONLY MODE AVAILABLE)</mode>
    <mode name="#yolo" disabled="true">DISABLED - All workflows require user interaction and approval at each step</mode>
  </execution-modes>

  <supported-tags desc="Instructions can use these tags">
    <structural>
      <tag>step n="X" goal="..." - Define step with number and goal</tag>
      <tag>optional="true" - Step can be skipped</tag>
      <tag>if="condition" - Conditional execution</tag>
      <tag>for-each="collection" - Iterate over items</tag>
      <tag>repeat="n" - Repeat n times</tag>
    </structural>
    <execution>
      <tag>action - Required action to perform</tag>
      <tag>action if="condition" - Single conditional action (inline, no closing tag needed)</tag>
      <tag>check if="condition"&gt;...&lt;/check&gt; - Conditional block wrapping multiple items (closing tag required)</tag>
      <tag>ask - Get user input (wait for response)</tag>
      <tag>goto - Jump to another step</tag>
      <tag>invoke-workflow - Call another workflow</tag>
      <tag>invoke-task - Call a task</tag>
      <tag>invoke-protocol - Execute a reusable protocol (e.g., discover_inputs)</tag>
    </execution>
    <output>
      <tag>template-output - Save content checkpoint</tag>
      <tag>critical - Cannot be skipped</tag>
      <tag>example - Show example output</tag>
    </output>
  </supported-tags>

  <conditional-execution-patterns desc="When to use each pattern">
    <pattern type="single-action">
      <use-case>One action with a condition</use-case>
      <syntax>&lt;action if="condition"&gt;Do something&lt;/action&gt;</syntax>
      <example>&lt;action if="file exists"&gt;Load the file&lt;/action&gt;</example>
      <rationale>Cleaner and more concise for single items</rationale>
    </pattern>

    <pattern type="multi-action-block">
      <use-case>Multiple actions/tags under same condition</use-case>
      <syntax>&lt;check if="condition"&gt;
        &lt;action&gt;First action&lt;/action&gt;
        &lt;action&gt;Second action&lt;/action&gt;
        &lt;/check&gt;</syntax>
      <example>&lt;check if="validation fails"&gt;
        &lt;action&gt;Log error&lt;/action&gt;
        &lt;goto step="1"&gt;Retry&lt;/goto&gt;
        &lt;/check&gt;</example>
      <rationale>Explicit scope boundaries prevent ambiguity</rationale>
    </pattern>

    <pattern type="nested-conditions">
      <use-case>Else/alternative branches</use-case>
      <syntax>&lt;check if="condition A"&gt;...&lt;/check&gt;
        &lt;check if="else"&gt;...&lt;/check&gt;</syntax>
      <rationale>Clear branching logic with explicit blocks</rationale>
    </pattern>
  </conditional-execution-patterns>

  <protocols desc="Reusable workflow protocols that can be invoked via invoke-protocol tag">
    <protocol name="discover_inputs" desc="Smart file discovery and loading based on input_file_patterns">
      <objective>Intelligently load project files (whole or sharded) based on workflow's input_file_patterns configuration</objective>

      <critical>Only execute if workflow.yaml contains input_file_patterns section</critical>

      <flow>
        <step n="1" title="Parse Input File Patterns">
          <action>Read input_file_patterns from loaded workflow.yaml</action>
          <action>For each pattern group (prd, architecture, epics, etc.), note the load_strategy if present</action>
        </step>

        <step n="2" title="Load Files Using Smart Strategies">
          <iterate>For each pattern in input_file_patterns:</iterate>

          <substep n="2a" title="Try Whole Document First">
            <action>Attempt glob match on 'whole' pattern (e.g., "{output_folder}/*prd*.md")</action>
            <check if="matches found">
              <action>Load ALL matching files completely (no offset/limit)</action>
              <action>Store content in variable: {pattern_name_content} (e.g., {prd_content})</action>
              <action>Mark pattern as RESOLVED, skip to next pattern</action>
            </check>
          </substep>

          <substep n="2b" title="Try Sharded Document if Whole Not Found">
            <check if="no whole matches AND sharded pattern exists">
              <action>Determine load_strategy from pattern config (defaults to FULL_LOAD if not specified)</action>

              <strategy name="FULL_LOAD">
                <desc>Load ALL files in sharded directory - used for PRD, Architecture, UX, brownfield docs</desc>
                <action>Use glob pattern to find ALL .md files (e.g., "{output_folder}/*architecture*/*.md")</action>
                <action>Load EVERY matching file completely</action>
                <action>Concatenate content in logical order (index.md first if exists, then alphabetical)</action>
                <action>Store in variable: {pattern_name_content}</action>
              </strategy>

              <strategy name="SELECTIVE_LOAD">
                <desc>Load specific shard using template variable - example: used for epics with {{epic_num}}</desc>
                <action>Check for template variables in sharded_single pattern (e.g., {{epic_num}})</action>
                <action>If variable undefined, ask user for value OR infer from context</action>
                <action>Resolve template to specific file path</action>
                <action>Load that specific file</action>
                <action>Store in variable: {pattern_name_content}</action>
              </strategy>

              <strategy name="INDEX_GUIDED">
                <desc>Load index.md, analyze structure and description of each doc in the index, then intelligently load relevant docs</desc>
                <mandate>DO NOT BE LAZY - use best judgment to load documents that might have relevant information, even if only a 5% chance</mandate>
                <action>Load index.md from sharded directory</action>
                <action>Parse table of contents, links, section headers</action>
                <action>Analyze workflow's purpose and objective</action>
                <action>Identify which linked/referenced documents are likely relevant</action>
                <example>If workflow is about authentication and index shows "Auth Overview", "Payment Setup", "Deployment" → Load auth
                  docs, consider deployment docs, skip payment</example>
                <action>Load all identified relevant documents</action>
                <action>Store combined content in variable: {pattern_name_content}</action>
                <note>When in doubt, LOAD IT - context is valuable, being thorough is better than missing critical info</note>
              </strategy>
            </check>
          </substep>

          <substep n="2c" title="Handle Not Found">
            <check if="no matches for whole OR sharded">
              <action>Set {pattern_name_content} to empty string</action>
              <action>Note in session: "No {pattern_name} files found" (not an error, just unavailable, offer use change to provide)</action>
            </check>
          </substep>
        </step>

        <step n="3" title="Report Discovery Results">
          <action>List all loaded content variables with file counts</action>
          <example>
            ✓ Loaded {prd_content} from 1 file: PRD.md
            ✓ Loaded {architecture_content} from 5 sharded files: architecture/index.md, architecture/system-design.md, ...
            ✓ Loaded {epics_content} from selective load: epics/epic-3.md
            ○ No ux_design files found
          </example>
          <note>This gives workflow transparency into what context is available</note>
        </step>
      </flow>

      <usage-in-instructions>
        <example desc="Typical usage in workflow instructions.md">
          &lt;step n="0" goal="Discover and load project context"&gt;
          &lt;invoke-protocol name="discover_inputs" /&gt;
          &lt;/step&gt;

          &lt;step n="1" goal="Analyze requirements"&gt;
          &lt;action&gt;Review {prd_content} for functional requirements&lt;/action&gt;
          &lt;action&gt;Cross-reference with {architecture_content} for technical constraints&lt;/action&gt;
          &lt;/step&gt;
        </example>
      </usage-in-instructions>
    </protocol>
  </protocols>

  <llm final="true">
    <mandate>This is the complete workflow execution engine</mandate>
    <mandate>You MUST Follow instructions exactly as written and maintain conversation context between steps</mandate>
    <mandate>If confused, re-read this task, the workflow yaml, and any yaml indicated files</mandate>
  </llm>
</task>